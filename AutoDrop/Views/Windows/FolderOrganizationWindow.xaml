<Window x:Class="AutoDrop.Views.Windows.FolderOrganizationWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:viewmodels="clr-namespace:AutoDrop.ViewModels"
        xmlns:converters="clr-namespace:AutoDrop.Converters"
        mc:Ignorable="d"
        Title="Organize Folder"
        Width="750"
        Height="850"
        MinWidth="600"
        MinHeight="650"
        Topmost="True"
        WindowStartupLocation="CenterScreen"
        ResizeMode="CanResizeWithGrip"
        Background="{DynamicResource ApplicationBackgroundBrush}"
        d:DataContext="{d:DesignInstance viewmodels:FolderOrganizationViewModel, IsDesignTimeCreatable=False}">

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <converters:FileSizeConverter x:Key="FileSizeConverter"/>
        <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <converters:CriteriaAppearanceConverter x:Key="CriteriaAppearanceConverter"/>
        <converters:ZeroToTrueConverter x:Key="ZeroToTrueConverter"/>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*" MinHeight="200"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header - Compact -->
        <Border Grid.Row="0" 
                Margin="0,0,0,12"
                Padding="12"
                CornerRadius="8"
                Background="{DynamicResource ControlFillColorDefaultBrush}">
            <DockPanel>
                <ui:SymbolIcon Symbol="Folder24" FontSize="24" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="Organize Folder"
                               FontSize="18"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding FolderName}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="350"
                                   ToolTip="{Binding FolderPath}"/>
                        <TextBlock Text=" • " Foreground="{DynamicResource TextFillColorTertiaryBrush}"/>
                        <TextBlock FontSize="12" Foreground="{DynamicResource TextFillColorTertiaryBrush}">
                            <Run Text="{Binding TotalFileCount, Mode=OneWay}"/>
                            <Run Text="files"/>
                        </TextBlock>
                    </StackPanel>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Organization Criteria Selection - Compact -->
        <Border Grid.Row="1"
                CornerRadius="8"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                BorderThickness="1"
                Padding="12"
                Margin="0,0,0,12">
            <StackPanel>
                <TextBlock Text="Organize by:"
                           FontWeight="SemiBold"
                           FontSize="13"
                           Margin="0,0,0,8"
                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                
                <!-- Criteria buttons - Compact -->
                <WrapPanel>
                    <ui:Button Appearance="{Binding SelectedCriteria, Converter={StaticResource CriteriaAppearanceConverter}, ConverterParameter=ByExtension}"
                               Command="{Binding SelectCriteriaCommand}"
                               CommandParameter="ByExtension"
                               Margin="0,0,6,6"
                               Padding="10,6"
                               ToolTip="Group files by their file extension (.pdf, .jpg, etc.)">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="DocumentText24" FontSize="14" Margin="0,0,5,0"/>
                            <TextBlock Text="Extension" VerticalAlignment="Center" FontSize="12"/>
                        </StackPanel>
                    </ui:Button>
                    <ui:Button Appearance="{Binding SelectedCriteria, Converter={StaticResource CriteriaAppearanceConverter}, ConverterParameter=ByCategory}"
                               Command="{Binding SelectCriteriaCommand}"
                               CommandParameter="ByCategory"
                               Margin="0,0,6,6"
                               Padding="10,6"
                               ToolTip="Group files by type (Documents, Images, Videos, etc.)">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="Grid24" FontSize="14" Margin="0,0,5,0"/>
                            <TextBlock Text="Category" VerticalAlignment="Center" FontSize="12"/>
                        </StackPanel>
                    </ui:Button>
                    <ui:Button Appearance="{Binding SelectedCriteria, Converter={StaticResource CriteriaAppearanceConverter}, ConverterParameter=BySize}"
                               Command="{Binding SelectCriteriaCommand}"
                               CommandParameter="BySize"
                               Margin="0,0,6,6"
                               Padding="10,6"
                               ToolTip="Group files by size (Tiny, Small, Medium, Large, Huge)">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="ArrowSort24" FontSize="14" Margin="0,0,5,0"/>
                            <TextBlock Text="Size" VerticalAlignment="Center" FontSize="12"/>
                        </StackPanel>
                    </ui:Button>
                    <ui:Button Appearance="{Binding SelectedCriteria, Converter={StaticResource CriteriaAppearanceConverter}, ConverterParameter=ByDate}"
                               Command="{Binding SelectCriteriaCommand}"
                               CommandParameter="ByDate"
                               Margin="0,0,6,6"
                               Padding="10,6"
                               ToolTip="Group files by creation or modification date">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="Calendar24" FontSize="14" Margin="0,0,5,0"/>
                            <TextBlock Text="Date" VerticalAlignment="Center" FontSize="12"/>
                        </StackPanel>
                    </ui:Button>
                    <ui:Button Appearance="{Binding SelectedCriteria, Converter={StaticResource CriteriaAppearanceConverter}, ConverterParameter=ByName}"
                               Command="{Binding SelectCriteriaCommand}"
                               CommandParameter="ByName"
                               Margin="0,0,6,6"
                               Padding="10,6"
                               ToolTip="AI analyzes filenames to suggest smart groupings">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="Sparkle24" FontSize="14" Margin="0,0,5,0" Foreground="#FFD700"/>
                            <TextBlock Text="Name (AI)" VerticalAlignment="Center" FontSize="12"/>
                        </StackPanel>
                    </ui:Button>
                    <ui:Button Appearance="{Binding SelectedCriteria, Converter={StaticResource CriteriaAppearanceConverter}, ConverterParameter=ByContent}"
                               Command="{Binding SelectCriteriaCommand}"
                               CommandParameter="ByContent"
                               IsEnabled="{Binding IsAiAvailable}"
                               Margin="0,0,6,6"
                               Padding="10,6"
                               ToolTip="{Binding AiStatusMessage}">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="Sparkle24" FontSize="14" Margin="0,0,5,0" Foreground="#FFD700"/>
                            <TextBlock Text="Content (AI)" VerticalAlignment="Center" FontSize="12"/>
                        </StackPanel>
                    </ui:Button>
                </WrapPanel>
            </StackPanel>
        </Border>

        <!-- Options Panel - Collapsible -->
        <Border Grid.Row="2"
                CornerRadius="8"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                BorderThickness="1"
                Margin="0,0,0,12">
            <Expander Padding="12" IsExpanded="False">
                <Expander.Header>
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="Settings24" FontSize="16" Margin="0,0,8,0"/>
                        <TextBlock Text="Options"
                                   FontWeight="SemiBold"
                                   FontSize="13"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                    </StackPanel>
                </Expander.Header>
                <StackPanel Margin="0,8,0,0">
                    <WrapPanel>
                        <CheckBox Content="Include subdirectories"
                                  IsChecked="{Binding IncludeSubdirectories}"
                                  Margin="0,0,20,8"/>
                        <CheckBox Content="Skip hidden files"
                                  IsChecked="{Binding SkipHiddenFiles}"
                                  Margin="0,0,20,8"/>
                    </WrapPanel>

                    <!-- Date Options -->
                    <StackPanel Visibility="{Binding IsDateOptionsVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="0,8,0,0">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Date format:" VerticalAlignment="Center" Margin="0,0,12,0"/>
                            <ComboBox ItemsSource="{Binding DateFormatOptions}"
                                      SelectedValue="{Binding SelectedDateFormat}"
                                      SelectedValuePath="Value"
                                      DisplayMemberPath="DisplayName"
                                      MinWidth="180"/>
                        </StackPanel>
                        <CheckBox Content="Use creation date (instead of modification date)"
                                  IsChecked="{Binding UseCreationDate}"/>
                    </StackPanel>

                    <!-- AI Options -->
                    <StackPanel Visibility="{Binding IsAiOptionsVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="0,8,0,0">
                        <Border Background="{DynamicResource SystemFillColorCautionBackgroundBrush}"
                                CornerRadius="4"
                                Padding="10,6"
                                Margin="0,0,0,10">
                            <TextBlock TextWrapping="Wrap" FontSize="11" Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                                <Run Text="⚠️ AI Analysis:" FontWeight="SemiBold" Foreground="{DynamicResource SystemFillColorCautionBrush}"/>
                                <Run Text="Limited to prevent API rate limits. Files beyond the limit use fallback categorization."/>
                            </TextBlock>
                        </Border>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                <TextBlock Text="Max files to analyze:" FontSize="12" Margin="0,0,0,4"/>
                                <ui:NumberBox Value="{Binding MaxAiFiles}"
                                              Minimum="1"
                                              Maximum="50"
                                              SpinButtonPlacementMode="Compact"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                <TextBlock Text="Max file size (MB):" FontSize="12" Margin="0,0,0,4"/>
                                <ui:NumberBox Value="{Binding MaxFileSizeMb}"
                                              Minimum="1"
                                              Maximum="50"
                                              SpinButtonPlacementMode="Compact"/>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </StackPanel>
            </Expander>
        </Border>

        <!-- Preview Button (shown when no preview yet) -->
        <Border Grid.Row="3"
                CornerRadius="8"
                Background="{DynamicResource ControlFillColorSecondaryBrush}"
                BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                BorderThickness="1"
                Visibility="{Binding IsPreviewed, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Margin="40">
                <ui:SymbolIcon Symbol="Eye24" FontSize="48" Foreground="{DynamicResource TextFillColorTertiaryBrush}" HorizontalAlignment="Center"/>
                <TextBlock Text="Click to preview how files will be organized"
                           FontSize="14"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           HorizontalAlignment="Center"
                           Margin="0,12,0,16"/>
                <ui:Button Content="Preview Organization"
                           Appearance="Primary"
                           Command="{Binding PreviewCommand}"
                           HorizontalAlignment="Center"
                           Padding="20,10"
                           Icon="{ui:SymbolIcon Eye24}"/>
            </StackPanel>
        </Border>

        <!-- Results Preview -->
        <Border Grid.Row="3"
                CornerRadius="8"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                BorderThickness="1"
                Margin="0,0,0,12"
                Visibility="{Binding IsPreviewed, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Preview Header -->
                <Border Grid.Row="0" Padding="12,10" BorderThickness="0,0,0,1" 
                        BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                        Background="{DynamicResource ControlFillColorSecondaryBrush}">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                            <ui:Button Content="Refresh"
                                       Appearance="Secondary"
                                       Command="{Binding PreviewCommand}"
                                       Padding="8,4"
                                       FontSize="11"
                                       Margin="0,0,8,0"
                                       Icon="{ui:SymbolIcon ArrowSync24}"/>
                            <ui:Button Content="All"
                                       Appearance="Secondary"
                                       Command="{Binding SelectAllCommand}"
                                       Padding="8,4"
                                       FontSize="11"
                                       Margin="0,0,4,0"/>
                            <ui:Button Content="None"
                                       Appearance="Secondary"
                                       Command="{Binding DeselectAllCommand}"
                                       Padding="8,4"
                                       FontSize="11"/>
                        </StackPanel>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock FontWeight="SemiBold" FontSize="14" Foreground="{DynamicResource TextFillColorPrimaryBrush}">
                                <Run Text="{Binding GroupCount, Mode=OneWay}"/>
                                <Run Text="folders will be created"/>
                            </TextBlock>
                            <TextBlock FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                                <Run Text="{Binding SelectedFileCount, Mode=OneWay}"/>
                                <Run Text="of"/>
                                <Run Text="{Binding TotalFileCount, Mode=OneWay}"/>
                                <Run Text="files selected"/>
                            </TextBlock>
                        </StackPanel>
                    </DockPanel>
                </Border>

                <!-- Groups List -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="8">
                    <ItemsControl ItemsSource="{Binding Groups}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Margin="4,4,4,8"
                                        Padding="12"
                                        CornerRadius="6"
                                        Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                        BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                                        BorderThickness="1">
                                    <Expander IsExpanded="False">
                                        <Expander.Header>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <CheckBox Grid.Column="0"
                                                          IsChecked="{Binding IsAllSelected}"
                                                          VerticalAlignment="Center"
                                                          Margin="0,0,12,0"/>
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding FolderName}"
                                                               FontWeight="SemiBold"
                                                               FontSize="13"
                                                               Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                    <TextBlock FontSize="11"
                                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                                                        <Run Text="{Binding SelectedCount, Mode=OneWay}"/>
                                                        <Run Text="/"/>
                                                        <Run Text="{Binding FileCount, Mode=OneWay}"/>
                                                        <Run Text="files •"/>
                                                        <Run Text="{Binding TotalSize, Mode=OneWay, Converter={StaticResource FileSizeConverter}}"/>
                                                    </TextBlock>
                                                </StackPanel>
                                                <ui:SymbolIcon Grid.Column="2"
                                                               Symbol="CheckmarkCircle24"
                                                               FontSize="16"
                                                               Foreground="Green"
                                                               Visibility="{Binding FolderExists, Converter={StaticResource BoolToVisibilityConverter}}"
                                                               ToolTip="Folder already exists"/>
                                            </Grid>
                                        </Expander.Header>
                                        <ItemsControl ItemsSource="{Binding Files}" Margin="28,8,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Margin="0,2" Padding="8,4"
                                                            CornerRadius="4"
                                                            Background="{DynamicResource ControlFillColorDefaultBrush}">
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="Auto"/>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <CheckBox Grid.Column="0"
                                                                      IsChecked="{Binding IsSelected}"
                                                                      IsEnabled="{Binding IsSkipped, Converter={StaticResource InverseBoolConverter}}"
                                                                      VerticalAlignment="Center"
                                                                      Margin="0,0,8,0"/>
                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                <TextBlock Text="{Binding FileName}"
                                                                           TextTrimming="CharacterEllipsis"
                                                                           FontSize="12"
                                                                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                                <TextBlock Text="{Binding SkipReason}"
                                                                           Visibility="{Binding IsSkipped, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                           FontSize="10"
                                                                           Foreground="{DynamicResource SystemFillColorCautionBrush}"
                                                                           TextWrapping="Wrap"/>
                                                            </StackPanel>
                                                            <TextBlock Grid.Column="2"
                                                                       Text="{Binding Size, Converter={StaticResource FileSizeConverter}}"
                                                                       FontSize="11"
                                                                       Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                                                       VerticalAlignment="Center"/>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Expander>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Progress -->
        <Border Grid.Row="4"
                Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}"
                CornerRadius="8"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                Padding="12"
                Margin="0,0,0,12">
            <StackPanel>
                <DockPanel Margin="0,0,0,8">
                    <TextBlock DockPanel.Dock="Right"
                               Text="{Binding ProgressPercent, StringFormat={}{0}%}"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                    <TextBlock Text="{Binding ProgressStatus}"
                               FontSize="13"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                </DockPanel>
                <ProgressBar Value="{Binding ProgressPercent}"
                             Height="6"
                             IsIndeterminate="{Binding ProgressPercent, Converter={StaticResource ZeroToTrueConverter}}"/>
                <TextBlock Text="{Binding CurrentFile}"
                           FontSize="11"
                           Margin="0,6,0,0"
                           TextTrimming="CharacterEllipsis"
                           Foreground="{DynamicResource TextFillColorTertiaryBrush}"/>
            </StackPanel>
        </Border>

        <!-- Footer Buttons -->
        <Border Grid.Row="5"
                BorderThickness="0,1,0,0"
                BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                Padding="0,12,0,0">
            <DockPanel>
                <ui:Button DockPanel.Dock="Left"
                           Content="Cancel Operation"
                           Command="{Binding CancelCommand}"
                           Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}"
                           Appearance="Danger"
                           Padding="16,8"
                           Icon="{ui:SymbolIcon Dismiss24}"/>
                <StackPanel DockPanel.Dock="Right"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right">
                    <ui:Button Content="Close"
                               Command="{Binding CloseCommand}"
                               Appearance="Secondary"
                               Padding="16,8"
                               Margin="0,0,12,0"
                               Visibility="{Binding IsProcessing, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                    <ui:Button Command="{Binding OrganizeCommand}"
                               Appearance="Primary"
                               Padding="20,8"
                               Visibility="{Binding IsProcessing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="ArrowSort24" Margin="0,0,8,0"/>
                            <TextBlock VerticalAlignment="Center">
                                <Run Text="Organize"/>
                                <Run Text="{Binding SelectedFileCount, Mode=OneWay}"/>
                                <Run Text="Files"/>
                            </TextBlock>
                        </StackPanel>
                    </ui:Button>
                </StackPanel>
                <StackPanel/>
            </DockPanel>
        </Border>
    </Grid>
</Window>