<ui:FluentWindow x:Class="AutoDrop.Views.Windows.RulesManagerWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                 xmlns:viewmodels="clr-namespace:AutoDrop.ViewModels"
                 mc:Ignorable="d"
                 Title="Manage Rules &amp; Folders"
                 Width="700"
                 Height="550"
                 MinWidth="600"
                 MinHeight="450"
                 WindowStartupLocation="CenterScreen"
                 ExtendsContentIntoTitleBar="True"
                 d:DataContext="{d:DesignInstance viewmodels:RulesManagerViewModel, IsDesignTimeCreatable=False}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0" Title="Manage Rules &amp; Folders"/>

        <!-- Main Content -->
        <TabControl Grid.Row="1" 
                    Margin="16,8,16,16"
                    SelectedIndex="{Binding SelectedTabIndex}">
            
            <!-- Rules Tab -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="DocumentBulletList24" Margin="0,0,8,0"/>
                        <TextBlock Text="File Rules"/>
                    </StackPanel>
                </TabItem.Header>
                
                <Grid Margin="0,12,0,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Search and Add Bar -->
                    <Grid Grid.Row="0" Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <ui:TextBox Grid.Column="0"
                                    PlaceholderText="Search rules by extension or destination..."
                                    Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                    Icon="{ui:SymbolIcon Search24}"
                                    Margin="0,0,12,0"/>

                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <ui:Button Content="Import"
                                       Icon="{ui:SymbolIcon ArrowDownload24}"
                                       Appearance="Secondary"
                                       Command="{Binding ImportRulesCommand}"
                                       Margin="0,0,8,0"/>
                            <ui:Button Content="Export"
                                       Icon="{ui:SymbolIcon ArrowUpload24}"
                                       Appearance="Secondary"
                                       Command="{Binding ExportRulesCommand}"
                                       Margin="0,0,8,0"/>
                            <ui:Button Content="Add Rule"
                                       Icon="{ui:SymbolIcon Add24}"
                                       Appearance="Primary"
                                       Command="{Binding ShowAddRuleCommand}"/>
                        </StackPanel>
                    </Grid>

                    <!-- Rules List -->
                    <Border Grid.Row="1"
                            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                            CornerRadius="8"
                            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1">
                        <Grid>
                            <!-- Empty State -->
                            <StackPanel VerticalAlignment="Center"
                                        HorizontalAlignment="Center"
                                        Visibility="{Binding Rules.Count, Converter={StaticResource InverseCountToVisibilityConverter}}">
                                <ui:SymbolIcon Symbol="DocumentBulletListOff24"
                                               FontSize="48"
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                <TextBlock Text="No rules defined yet"
                                           FontSize="16"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           Margin="0,12,0,4"/>
                                <TextBlock Text="Click 'Add Rule' to create your first rule"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextFillColorTertiaryBrush}"/>
                            </StackPanel>

                            <!-- Rules DataGrid -->
                            <DataGrid ItemsSource="{Binding FilteredRules}"
                                      SelectedItem="{Binding SelectedRule}"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      CanUserDeleteRows="False"
                                      IsReadOnly="True"
                                      SelectionMode="Single"
                                      GridLinesVisibility="None"
                                      HeadersVisibility="Column"
                                      Background="Transparent"
                                      BorderThickness="0">
                                <DataGrid.Columns>
                                    <!-- Extension Column -->
                                    <DataGridTemplateColumn Header="Extension" Width="100">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" Margin="8,0">
                                                    <ui:SymbolIcon Symbol="Document24" 
                                                                   FontSize="16" 
                                                                   Margin="0,0,8,0"
                                                                   Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                    <TextBlock Text="{Binding Extension}"
                                                               FontWeight="SemiBold"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <!-- Destination Column -->
                                    <DataGridTemplateColumn Header="Destination" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Destination}"
                                                           TextTrimming="CharacterEllipsis"
                                                           ToolTip="{Binding Destination}"
                                                           Margin="8,0"
                                                           VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <!-- Auto-Move Column -->
                                    <DataGridTemplateColumn Header="Auto" Width="60">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding AutoMove, Mode=OneWay}"
                                                          Command="{Binding DataContext.ToggleAutoMoveCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                          CommandParameter="{Binding}"
                                                          HorizontalAlignment="Center"
                                                          ToolTip="Enable auto-move without popup"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <!-- Enabled Column -->
                                    <DataGridTemplateColumn Header="Enabled" Width="70">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding IsEnabled, Mode=OneWay}"
                                                          Command="{Binding DataContext.ToggleRuleEnabledCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                          CommandParameter="{Binding}"
                                                          HorizontalAlignment="Center"
                                                          ToolTip="Enable or disable this rule"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <!-- Usage Column -->
                                    <DataGridTemplateColumn Header="Used" Width="60">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding UseCount, StringFormat={}{0}x}"
                                                           HorizontalAlignment="Center"
                                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <!-- Actions Column -->
                                    <DataGridTemplateColumn Header="Actions" Width="100">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                    <ui:Button Icon="{ui:SymbolIcon FolderOpen24}"
                                                               Appearance="Transparent"
                                                               Padding="4"
                                                               ToolTip="Change destination"
                                                               Command="{Binding DataContext.EditRuleDestinationCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                               CommandParameter="{Binding}"/>
                                                    <ui:Button Icon="{ui:SymbolIcon Delete24}"
                                                               Appearance="Transparent"
                                                               Padding="4"
                                                               ToolTip="Delete rule"
                                                               Command="{Binding DataContext.DeleteRuleCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                               CommandParameter="{Binding}"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </Border>

                    <!-- Add Rule Panel -->
                    <Border Grid.Row="2"
                            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                            CornerRadius="8"
                            BorderBrush="{DynamicResource AccentFillColorDefaultBrush}"
                            BorderThickness="1"
                            Padding="16"
                            Margin="0,12,0,0"
                            Visibility="{Binding IsAddingRule, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="2*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Extension Field -->
                            <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                <TextBlock Text="Extension" FontSize="12" Margin="0,0,0,4"/>
                                <ui:TextBox PlaceholderText=".pdf"
                                            Text="{Binding NewExtension, UpdateSourceTrigger=PropertyChanged}"/>
                            </StackPanel>

                            <!-- Destination Field -->
                            <StackPanel Grid.Column="1" Margin="0,0,8,0">
                                <TextBlock Text="Destination" FontSize="12" Margin="0,0,0,4"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ui:TextBox Grid.Column="0"
                                                Text="{Binding NewDestination, UpdateSourceTrigger=PropertyChanged}"
                                                PlaceholderText="Select folder..."/>
                                    <ui:Button Grid.Column="1"
                                               Icon="{ui:SymbolIcon FolderOpen24}"
                                               Appearance="Secondary"
                                               Command="{Binding BrowseNewRuleDestinationCommand}"
                                               Margin="4,0,0,0"/>
                                </Grid>
                            </StackPanel>

                            <CheckBox Grid.Column="2"
                                      Content="Auto-move"
                                      IsChecked="{Binding NewAutoMove}"
                                      VerticalAlignment="Bottom"
                                      Margin="0,0,16,0"/>

                            <StackPanel Grid.Column="3" 
                                        Orientation="Horizontal" 
                                        VerticalAlignment="Bottom">
                                <ui:Button Content="Cancel"
                                           Appearance="Secondary"
                                           Command="{Binding CancelAddRuleCommand}"
                                           Margin="0,0,8,0"/>
                                <ui:Button Content="Save"
                                           Appearance="Primary"
                                           Command="{Binding SaveNewRuleCommand}"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>

            <!-- Custom Folders Tab -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="FolderAdd24" Margin="0,0,8,0"/>
                        <TextBlock Text="Custom Folders"/>
                    </StackPanel>
                </TabItem.Header>

                <Grid Margin="0,12,0,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <DockPanel Grid.Row="0" Margin="0,0,0,12">
                        <ui:Button DockPanel.Dock="Right"
                                   Content="Add Folder"
                                   Icon="{ui:SymbolIcon Add24}"
                                   Appearance="Primary"
                                   Command="{Binding ShowAddFolderCommand}"/>
                        <TextBlock Text="Define custom destination folders that appear in suggestions"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                    </DockPanel>

                    <!-- Folders List -->
                    <Border Grid.Row="1"
                            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                            CornerRadius="8"
                            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1">
                        <Grid>
                            <!-- Empty State -->
                            <StackPanel VerticalAlignment="Center"
                                        HorizontalAlignment="Center"
                                        Visibility="{Binding CustomFolders.Count, Converter={StaticResource InverseCountToVisibilityConverter}}">
                                <ui:SymbolIcon Symbol="FolderProhibited24"
                                               FontSize="48"
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                <TextBlock Text="No custom folders defined"
                                           FontSize="16"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           Margin="0,12,0,4"/>
                                <TextBlock Text="Add folders like 'Work', 'Personal', or 'Projects'"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextFillColorTertiaryBrush}"/>
                            </StackPanel>

                            <!-- Folders ItemsControl -->
                            <ItemsControl ItemsSource="{Binding CustomFolders}"
                                          Margin="8"
                                          Visibility="{Binding CustomFolders.Count, Converter={StaticResource CountToVisibilityConverter}}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{DynamicResource SubtleFillColorSecondaryBrush}"
                                                CornerRadius="6"
                                                Padding="12,8"
                                                Margin="0,0,0,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Icon and Name -->
                                                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Icon}"
                                                               FontSize="20"
                                                               Margin="0,0,12,0"/>
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding Name}"
                                                                   FontWeight="SemiBold"
                                                                   FontSize="14"/>
                                                        <TextBlock Text="{Binding Path}"
                                                                   FontSize="11"
                                                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                                   TextTrimming="CharacterEllipsis"
                                                                   MaxWidth="350"/>
                                                    </StackPanel>
                                                </StackPanel>

                                                <!-- Stats -->
                                                <StackPanel Grid.Column="1" 
                                                            Orientation="Horizontal" 
                                                            HorizontalAlignment="Right"
                                                            VerticalAlignment="Center"
                                                            Margin="16,0">
                                                    <TextBlock Text="{Binding UseCount, StringFormat=Used {0}x}"
                                                               FontSize="11"
                                                               Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                                               Margin="0,0,16,0"/>
                                                    <CheckBox Content="Pinned"
                                                              IsChecked="{Binding IsPinned, Mode=OneWay}"
                                                              Command="{Binding DataContext.ToggleFolderPinnedCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                              CommandParameter="{Binding}"
                                                              FontSize="11"/>
                                                </StackPanel>

                                                <!-- Actions -->
                                                <StackPanel Grid.Column="2" Orientation="Horizontal">
                                                    <ui:Button Icon="{ui:SymbolIcon FolderOpen24}"
                                                               Appearance="Transparent"
                                                               Padding="6"
                                                               ToolTip="Change path"
                                                               Command="{Binding DataContext.EditFolderPathCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                               CommandParameter="{Binding}"/>
                                                    <ui:Button Icon="{ui:SymbolIcon Delete24}"
                                                               Appearance="Transparent"
                                                               Padding="6"
                                                               ToolTip="Delete folder"
                                                               Command="{Binding DataContext.DeleteFolderCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                               CommandParameter="{Binding}"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Border>

                    <!-- Add Folder Panel -->
                    <Border Grid.Row="2"
                            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                            CornerRadius="8"
                            BorderBrush="{DynamicResource AccentFillColorDefaultBrush}"
                            BorderThickness="1"
                            Padding="16"
                            Margin="0,12,0,0"
                            Visibility="{Binding IsAddingFolder, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <Grid Grid.Row="0" Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="2*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Icon Selector -->
                                <ComboBox Grid.Column="0"
                                          ItemsSource="{Binding AvailableIcons}"
                                          SelectedItem="{Binding NewFolderIcon}"
                                          Width="70"
                                          Margin="0,0,8,0"
                                          VerticalAlignment="Bottom">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" FontSize="18" HorizontalAlignment="Center"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>

                                <!-- Name -->
                                <StackPanel Grid.Column="1" Margin="0,0,8,0">
                                    <TextBlock Text="Folder Name" FontSize="12" Margin="0,0,0,4"/>
                                    <ui:TextBox PlaceholderText="e.g., Work Projects"
                                                Text="{Binding NewFolderName, UpdateSourceTrigger=PropertyChanged}"/>
                                </StackPanel>

                                <!-- Parent Path -->
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Create In (Parent Folder)" FontSize="12" Margin="0,0,0,4"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <ui:TextBox Grid.Column="0"
                                                    Text="{Binding NewFolderPath, UpdateSourceTrigger=PropertyChanged}"
                                                    PlaceholderText="e.g., Desktop, Documents..."
                                                    IsReadOnly="True"/>
                                        <ui:Button Grid.Column="1"
                                                   Icon="{ui:SymbolIcon FolderOpen24}"
                                                   Appearance="Secondary"
                                                   Command="{Binding BrowseNewFolderPathCommand}"
                                                   Margin="4,0,0,0"
                                                   ToolTip="Browse to select parent folder"/>
                                    </Grid>
                                </StackPanel>
                            </Grid>

                            <!-- Info text -->
                            <TextBlock Grid.Row="1" 
                                       FontSize="11"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       Margin="0,0,0,12">
                                <Run Text="ðŸ’¡ A new folder named '"/><Run Text="{Binding NewFolderName, Mode=OneWay}" FontWeight="SemiBold"/><Run Text="' will be created inside the selected location."/>
                            </TextBlock>

                            <DockPanel Grid.Row="2">
                                <StackPanel DockPanel.Dock="Right" 
                                            Orientation="Horizontal">
                                    <ui:Button Content="Cancel"
                                               Appearance="Secondary"
                                               Command="{Binding CancelAddFolderCommand}"
                                               Margin="0,0,8,0"/>
                                    <ui:Button Content="Create Folder"
                                               Appearance="Primary"
                                               Command="{Binding SaveNewFolderCommand}"/>
                                </StackPanel>
                                
                                <CheckBox Content="Pin to suggestions"
                                          IsChecked="{Binding NewFolderPinned}"
                                          VerticalAlignment="Center"/>
                            </DockPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Loading Overlay -->
        <Border Grid.RowSpan="2"
                Background="#80000000"
                Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
            <ui:ProgressRing IsIndeterminate="True"
                             Width="48"
                             Height="48"/>
        </Border>
    </Grid>
</ui:FluentWindow>
