<ui:FluentWindow x:Class="AutoDrop.Views.Windows.BatchOperationWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:viewmodels="clr-namespace:AutoDrop.ViewModels"
        xmlns:converters="clr-namespace:AutoDrop.Converters"
        mc:Ignorable="d"
        Title="Organize Files"
        Width="700"
        Height="600"
        MinWidth="600"
        MinHeight="500"
        WindowStartupLocation="CenterScreen"
        ResizeMode="CanResizeWithGrip"
        ExtendsContentIntoTitleBar="True"
        d:DataContext="{d:DesignInstance viewmodels:BatchOperationViewModel, IsDesignTimeCreatable=False}">

    <ui:FluentWindow.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        
        <!-- Size Converter for display -->
        <converters:FileSizeConverter x:Key="FileSizeConverter"/>
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <ui:TitleBar Grid.Row="0" Title="Organize Files"/>

        <Grid Grid.Row="1" Margin="16,8,16,16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="Organize Files"
                       FontSize="20"
                       FontWeight="SemiBold"
                       Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
            <TextBlock FontSize="13"
                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                       Margin="0,4,0,0">
                <Run Text="{Binding TotalFiles, Mode=OneWay}"/>
                <Run Text="files will be organized to"/>
                <Run Text="{Binding TotalGroups, Mode=OneWay}"/>
                <Run Text="folders"/>
            </TextBlock>
        </StackPanel>

        <!-- Select All Toggle -->
        <DockPanel Grid.Row="1" Margin="0,0,0,8">
            <ui:Button DockPanel.Dock="Right"
                       Content="Toggle All"
                       Appearance="Secondary"
                       Command="{Binding ToggleAllCommand}"
                       Padding="12,4"
                       FontSize="11"/>
            <TextBlock Text="File Groups"
                       FontWeight="Medium"
                       FontSize="12"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
        </DockPanel>

        <!-- File Groups List -->
        <Border Grid.Row="2"
                CornerRadius="8"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                BorderThickness="1">
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          Padding="8">
                <ItemsControl ItemsSource="{Binding Groups}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="0,0,0,8"
                                    Padding="12,10"
                                    CornerRadius="6"
                                    Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                    BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                                    BorderThickness="1">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Selection Checkbox -->
                                    <CheckBox Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                                              IsChecked="{Binding IsSelected}"
                                              VerticalAlignment="Center"
                                              Margin="0,0,12,0"/>

                                    <!-- Group Info - Top Row -->
                                    <Grid Grid.Row="0" Grid.Column="1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding DisplayText}"
                                                   FontWeight="SemiBold"
                                                   FontSize="13"
                                                   VerticalAlignment="Center"
                                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                        <TextBlock Grid.Column="1"
                                                   Text="→"
                                                   Margin="8,0"
                                                   VerticalAlignment="Center"
                                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                        
                                        <!-- Destination ComboBox -->
                                        <ComboBox Grid.Column="2"
                                                  ItemsSource="{Binding AvailableDestinations}"
                                                  SelectedItem="{Binding SelectedDestination}"
                                                  MinWidth="120"
                                                  FontSize="12"
                                                  VerticalAlignment="Center"
                                                  ToolTip="{Binding SelectedDestination.FullPath}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal">
                                                        <ui:SymbolIcon Symbol="Folder24" FontSize="12" Margin="0,0,6,0"/>
                                                        <TextBlock Text="{Binding DisplayName}"
                                                                   TextTrimming="CharacterEllipsis"
                                                                   MaxWidth="120"/>
                                                        <TextBlock Text="★" 
                                                                   Margin="4,0,0,0"
                                                                   Foreground="Gold"
                                                                   FontSize="10"
                                                                   Visibility="{Binding IsFromRule, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                        
                                        <!-- Browse Button -->
                                        <ui:Button Grid.Column="3"
                                                   Icon="{ui:SymbolIcon FolderOpen24}"
                                                   Appearance="Secondary"
                                                   ToolTip="Browse for folder..."
                                                   Command="{Binding BrowseCommand}"
                                                   Padding="6,4"
                                                   Margin="6,0,0,0"
                                                   VerticalAlignment="Center"/>
                                    </Grid>

                                    <!-- File Count Badge -->
                                    <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="2"
                                            CornerRadius="10"
                                            Background="{DynamicResource AccentFillColorDefaultBrush}"
                                            Padding="10,4"
                                            VerticalAlignment="Center"
                                            Margin="8,0,0,0">
                                        <TextBlock Text="{Binding FileCount}"
                                                   FontSize="11"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"/>
                                    </Border>

                                    <!-- Info Row - Size, Category, and Full Path -->
                                    <TextBlock Grid.Row="1" Grid.Column="1"
                                               FontSize="11"
                                               Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                               Margin="0,6,0,0"
                                               TextTrimming="CharacterEllipsis"
                                               ToolTip="{Binding SelectedDestination.FullPath}">
                                        <Run Text="{Binding TotalSize, Converter={StaticResource FileSizeConverter}, Mode=OneWay}"/>
                                        <Run Text="•"/>
                                        <Run Text="{Binding Category, Mode=OneWay}"/>
                                        <Run Text="•"/>
                                        <Run Text="{Binding SelectedDestination.FullPath, Mode=OneWay}" 
                                             Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                    </TextBlock>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <!-- Duplicate Handling Options -->
        <StackPanel Grid.Row="3" Margin="0,12,0,0">
            <TextBlock Text="If duplicates found:"
                       FontSize="12"
                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                       Margin="0,0,0,6"/>
            <ComboBox ItemsSource="{Binding DuplicateHandlingOptions}"
                      SelectedValue="{Binding SelectedDuplicateHandling}"
                      SelectedValuePath="Value"
                      DisplayMemberPath="DisplayName"
                      HorizontalAlignment="Stretch"/>
        </StackPanel>

        <!-- Progress Section -->
        <StackPanel Grid.Row="4"
                    Margin="0,16,0,0"
                    Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}">
            <DockPanel Margin="0,0,0,8">
                <TextBlock DockPanel.Dock="Right"
                           Text="{Binding ProgressPercent, StringFormat={}{0}%}"
                           FontSize="12"
                           FontWeight="Medium"
                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                <TextBlock Text="{Binding CurrentItem}"
                           FontSize="12"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           TextTrimming="CharacterEllipsis"/>
            </DockPanel>
            <ProgressBar Value="{Binding ProgressPercent}"
                         Maximum="100"
                         Height="6"/>
            <TextBlock Text="{Binding ProgressStatus}"
                       FontSize="11"
                       Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                       Margin="0,4,0,0"/>
        </StackPanel>

        <!-- Action Buttons -->
        <Grid Grid.Row="5" Margin="0,16,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <ui:Button Grid.Column="1"
                       Content="Cancel"
                       Appearance="Secondary"
                       Command="{Binding CancelCommand}"
                       Padding="20,8"
                       Margin="0,0,8,0"/>

            <ui:Button Grid.Column="2"
                       Appearance="Primary"
                       Command="{Binding ExecuteCommand}"
                       Padding="20,8"
                       IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                <StackPanel Orientation="Horizontal">
                    <ui:SymbolIcon Symbol="FolderArrowRight24" Margin="0,0,8,0"/>
                    <TextBlock Text="Organize All"/>
                </StackPanel>
            </ui:Button>
        </Grid>
        </Grid>
    </Grid>
</ui:FluentWindow>
