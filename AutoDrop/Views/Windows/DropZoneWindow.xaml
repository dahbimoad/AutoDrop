<Window x:Class="AutoDrop.Views.Windows.DropZoneWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:viewmodels="clr-namespace:AutoDrop.ViewModels"
        mc:Ignorable="d"
        Title="AutoDrop"
        Width="160"
        Height="160"
        MinWidth="140"
        MinHeight="140"
        MaxWidth="200"
        MaxHeight="200"
        Topmost="True"
        WindowStyle="None"
        AllowsTransparency="True"
        ResizeMode="NoResize"
        ShowInTaskbar="False"
        WindowStartupLocation="Manual"
        Background="Transparent"
        d:DataContext="{d:DesignInstance viewmodels:DropZoneViewModel, IsDesignTimeCreatable=False}">

    <Grid>
        <!-- Drop Zone Border -->
        <Border x:Name="DropZoneBorder"
                CornerRadius="12"
                Background="{DynamicResource ApplicationBackgroundBrush}"
                BorderThickness="2"
                BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                AllowDrop="True"
                DragEnter="OnDragEnter"
                DragLeave="OnDragLeave"
                Drop="OnDrop"
                MouseLeftButtonDown="OnMouseLeftButtonDown">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Action Buttons -->
                <Grid Grid.Row="0" Margin="4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Settings/Rules Button -->
                    <ui:Button Grid.Column="0"
                               Icon="{ui:SymbolIcon Settings24}"
                               Appearance="Transparent"
                               ToolTip="Manage Rules &amp; Folders"
                               Click="OnSettingsClick"
                               Padding="4"
                               FontSize="10"/>
                    
                    <!-- Close/Minimize Buttons -->
                    <StackPanel Grid.Column="2" 
                                Orientation="Horizontal">
                        <ui:Button Icon="{ui:SymbolIcon Subtract24}"
                                   Appearance="Transparent"
                                   ToolTip="Minimize to Tray"
                                   Click="OnMinimizeClick"
                                   Padding="4"
                                   FontSize="10"/>
                        <ui:Button Icon="{ui:SymbolIcon Dismiss24}"
                                   Appearance="Transparent"
                                   ToolTip="Close"
                                   Click="OnCloseClick"
                                   Padding="4"
                                   FontSize="10"/>
                    </StackPanel>
                </Grid>

                <!-- Drop Icon and Text -->
                <StackPanel Grid.Row="1" 
                            VerticalAlignment="Center" 
                            HorizontalAlignment="Center">
                    <ui:SymbolIcon x:Name="DropIcon"
                                   Symbol="ArrowDownload24"
                                   FontSize="36"
                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                    <TextBlock x:Name="StatusTextBlock"
                               Text="{Binding StatusText}"
                               FontSize="11"
                               TextWrapping="Wrap"
                               TextAlignment="Center"
                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                               Margin="8,8,8,0"
                               MaxWidth="120"/>
                </StackPanel>

                <!-- File Count Badge -->
                <Border x:Name="CountBadge"
                        Grid.Row="2"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,8"
                        CornerRadius="8"
                        Background="{DynamicResource AccentTextFillColorPrimaryBrush}"
                        Padding="8,2"
                        Visibility="Collapsed">
                    <TextBlock x:Name="CountText"
                               FontSize="10"
                               Foreground="White"/>
                </Border>
            </Grid>
        </Border>

        <!-- Suggestion Popup -->
        <Popup x:Name="SuggestionPopup"
               IsOpen="{Binding IsPopupOpen, Mode=TwoWay}"
               StaysOpen="True"
               Placement="Right"
               HorizontalOffset="8"
               AllowsTransparency="True"
               PopupAnimation="Fade">
            <Border CornerRadius="8"
                    Background="{DynamicResource ApplicationBackgroundBrush}"
                    BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                    BorderThickness="1"
                    Padding="12"
                    MinWidth="220"
                    MaxWidth="300">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <DockPanel Grid.Row="0" Margin="0,0,0,12">
                        <ui:Button DockPanel.Dock="Right"
                                   Icon="{ui:SymbolIcon Dismiss24}"
                                   Appearance="Transparent"
                                   Padding="4"
                                   Command="{Binding CancelCommand}"/>
                        <StackPanel>
                            <TextBlock Text="{Binding CurrentItem.Name}"
                                       FontWeight="SemiBold"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                       TextTrimming="CharacterEllipsis"
                                       ToolTip="{Binding CurrentItem.Name}"
                                       MaxWidth="180"/>
                            <TextBlock Text="{Binding CurrentItem.Category}"
                                       FontSize="11"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                        </StackPanel>
                    </DockPanel>

                    <!-- Destination Buttons -->
                    <ItemsControl Grid.Row="1" 
                                  ItemsSource="{Binding Suggestions}"
                                  Margin="0,0,0,8">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <ui:Button Margin="0,0,0,4"
                                           HorizontalAlignment="Stretch"
                                           HorizontalContentAlignment="Left"
                                           ToolTip="{Binding FullPath}"
                                           Command="{Binding DataContext.MoveToDestinationCommand, RelativeSource={RelativeSource AncestorType=Popup}}"
                                           CommandParameter="{Binding}">
                                    <ui:Button.Style>
                                        <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsRecommended}" Value="True">
                                                    <Setter Property="Appearance" Value="Primary"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:Button.Style>
                                    <StackPanel Orientation="Horizontal">
                                        <ui:SymbolIcon Symbol="Folder24" Margin="0,0,8,0"/>
                                        <TextBlock Text="{Binding DisplayName}" 
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxWidth="150"/>
                                        <TextBlock Text="â˜…" 
                                                   Margin="4,0,0,0"
                                                   Foreground="Gold"
                                                   Visibility="{Binding IsFromRule, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                    </StackPanel>
                                </ui:Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Browse Button -->
                    <ui:Button Grid.Row="2"
                               Content="Browse other folder..."
                               HorizontalAlignment="Stretch"
                               Appearance="Secondary"
                               Command="{Binding BrowseDestinationCommand}"
                               Margin="0,0,0,12"/>

                    <!-- Remember Checkbox -->
                    <CheckBox Grid.Row="3"
                              Content="{Binding CurrentItem.Extension, StringFormat='Always move {0} files here'}"
                              IsChecked="{Binding RememberChoice}"
                              FontSize="11"
                              Visibility="{Binding CurrentItem.IsDirectory, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                    
                    <!-- Auto-Move Checkbox (shown when Remember is checked) -->
                    <CheckBox Grid.Row="4"
                              Content="Enable auto-move (skip popup)"
                              IsChecked="{Binding EnableAutoMove}"
                              FontSize="11"
                              Margin="16,4,0,0"
                              Visibility="{Binding RememberChoice, Converter={StaticResource BoolToVisibilityConverter}}"
                              ToolTip="When enabled, files with this extension will be moved automatically without showing the popup"/>
                </Grid>
            </Border>
        </Popup>

        <!-- Snackbar Presenter for notifications -->
        <ui:SnackbarPresenter x:Name="SnackbarPresenter"
                              VerticalAlignment="Bottom"
                              HorizontalAlignment="Center"
                              Margin="0,0,0,170"/>

        <!-- Undo Popup - Shows when undo is available -->
        <Popup x:Name="UndoPopup"
               IsOpen="{Binding IsUndoAvailable}"
               StaysOpen="True"
               Placement="Bottom"
               PlacementTarget="{Binding ElementName=DropZoneBorder}"
               VerticalOffset="8"
               AllowsTransparency="True"
               PopupAnimation="Fade">
            <Border CornerRadius="8"
                    Background="{DynamicResource ApplicationBackgroundBrush}"
                    BorderBrush="{DynamicResource SystemAccentColorSecondaryBrush}"
                    BorderThickness="1.5"
                    Padding="12,10"
                    MinWidth="200"
                    MaxWidth="280">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Grid.Column="0" VerticalAlignment="Center" Margin="0,0,12,0">
                        <TextBlock Text="{Binding UndoTitle}"
                                   FontSize="10"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                        <TextBlock Text="{Binding UndoDescription}"
                                   FontSize="12"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                   TextTrimming="CharacterEllipsis"
                                   ToolTip="{Binding UndoDescription}"
                                   MaxWidth="160"/>
                    </StackPanel>
                    
                    <ui:Button Grid.Column="1"
                               Content="Undo"
                               Icon="{ui:SymbolIcon ArrowUndo24}"
                               Appearance="Primary"
                               Command="{Binding UndoCommand}"
                               Padding="12,6"
                               FontSize="12"/>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</Window>
