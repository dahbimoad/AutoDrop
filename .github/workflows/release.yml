# AutoDrop Release Pipeline
# Triggers when a version tag is pushed (e.g., v1.0.0)
# Creates GitHub Release with modern EXE installer + portable ZIP

name: Release

on:
  push:
    tags:
      - 'v*.*.*'       # Matches v1.0.0, v2.1.3, etc.
      - 'v*.*.*-*'     # Matches v1.0.0-pre, v1.0.0-beta, etc.

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'AutoDrop/AutoDrop.csproj'
  BUILD_CONFIGURATION: 'Release'

jobs:
  release:
    name: Create Release
    runs-on: windows-latest
    permissions:
      contents: write  # Required for creating releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          # For pre-release tags like v1.0.0-pre, extract base version for dotnet
          $baseVersion = $version -replace '-.*$', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "BASE_VERSION=$baseVersion" >> $env:GITHUB_OUTPUT
          echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Install Inno Setup for modern installer
      - name: Install Inno Setup
        run: choco install innosetup -y --no-progress
        shell: pwsh

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      # Build for Windows x64
      - name: Publish Windows x64
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --runtime win-x64 `
            --self-contained true `
            --output ./publish/win-x64 `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -p:Version=${{ steps.version.outputs.BASE_VERSION }}
        shell: pwsh

      # Build for Windows x86 (32-bit)
      - name: Publish Windows x86
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --runtime win-x86 `
            --self-contained true `
            --output ./publish/win-x86 `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -p:Version=${{ steps.version.outputs.BASE_VERSION }}
        shell: pwsh

      # Build for Windows ARM64
      - name: Publish Windows ARM64
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            --configuration ${{ env.BUILD_CONFIGURATION }} `
            --runtime win-arm64 `
            --self-contained true `
            --output ./publish/win-arm64 `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -p:Version=${{ steps.version.outputs.BASE_VERSION }}
        shell: pwsh

      # Create ZIP archives
      - name: Create release archives
        run: |
          Compress-Archive -Path ./publish/win-x64/* -DestinationPath ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-x64-portable.zip
          Compress-Archive -Path ./publish/win-x86/* -DestinationPath ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-x86-portable.zip
          Compress-Archive -Path ./publish/win-arm64/* -DestinationPath ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-arm64-portable.zip
        shell: pwsh

      # Create wizard images for installer
      - name: Create installer images
        run: |
          Push-Location installer
          powershell -ExecutionPolicy Bypass -File create-images.ps1
          Pop-Location
        shell: pwsh

      # Build Installer (x64) with Inno Setup
      - name: Build Installer (x64)
        run: |
          $env:APP_VERSION = "${{ steps.version.outputs.VERSION }}"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DAppVersion=${{ steps.version.outputs.VERSION }} `
            installer/AutoDrop.iss
          Move-Item -Path output/AutoDrop-${{ steps.version.outputs.VERSION }}-win-x64-setup.exe `
                    -Destination ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-x64-setup.exe
        shell: pwsh

      # Build Installer (x86) with Inno Setup
      - name: Build Installer (x86)
        run: |
          # Modify ISS for x86
          $issContent = Get-Content installer/AutoDrop.iss -Raw
          $issContent = $issContent -replace 'win-x64', 'win-x86'
          $issContent = $issContent -replace 'ArchitecturesAllowed=x64compatible', '; x86 build'
          $issContent = $issContent -replace 'ArchitecturesInstallIn64BitMode=x64compatible', '; x86 mode'
          $issContent = $issContent -replace 'OutputBaseFilename=AutoDrop-\{#MyAppVersion\}-win-x64-setup', 'OutputBaseFilename=AutoDrop-{#MyAppVersion}-win-x86-setup'
          $issContent | Set-Content installer/AutoDrop-x86.iss
          
          $env:APP_VERSION = "${{ steps.version.outputs.VERSION }}"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DAppVersion=${{ steps.version.outputs.VERSION }} `
            installer/AutoDrop-x86.iss
          Move-Item -Path output/AutoDrop-${{ steps.version.outputs.VERSION }}-win-x86-setup.exe `
                    -Destination ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-x86-setup.exe
        shell: pwsh

      # Generate SHA256 checksums
      - name: Generate checksums
        run: |
          $files = @(
            "AutoDrop-${{ steps.version.outputs.VERSION }}-win-x64-setup.exe",
            "AutoDrop-${{ steps.version.outputs.VERSION }}-win-x86-setup.exe",
            "AutoDrop-${{ steps.version.outputs.VERSION }}-win-x64-portable.zip",
            "AutoDrop-${{ steps.version.outputs.VERSION }}-win-x86-portable.zip",
            "AutoDrop-${{ steps.version.outputs.VERSION }}-win-arm64-portable.zip"
          )
          $checksums = @()
          foreach ($file in $files) {
            if (Test-Path $file) {
              $hash = (Get-FileHash $file -Algorithm SHA256).Hash.ToLower()
              $checksums += "$hash  $file"
            }
          }
          $checksums | Out-File -FilePath checksums.txt -Encoding utf8
        shell: pwsh

      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: AutoDrop ${{ steps.version.outputs.VERSION }}
          body: |
            ## AutoDrop ${{ steps.version.outputs.VERSION }}
            
            ### üéØ Recommended Download
            | Platform | Installer (Recommended) | Portable |
            |----------|------------------------|----------|
            | **Windows x64** | `AutoDrop-${{ steps.version.outputs.VERSION }}-win-x64-setup.exe` | `*-portable.zip` |
            | **Windows x86** | `AutoDrop-${{ steps.version.outputs.VERSION }}-win-x86-setup.exe` | `*-portable.zip` |
            | **Windows ARM64** | N/A | `*-portable.zip` |
            
            ### üì¶ Installer Features
            - ‚úÖ Modern Windows 11 style UI
            - ‚úÖ Desktop shortcut
            - ‚úÖ Start menu entry
            - ‚úÖ Auto-start with Windows (optional)
            - ‚úÖ Proper uninstaller (Add/Remove Programs)
            - ‚úÖ Per-user install (no admin required)
            
            ### üìÅ Portable Version
            - Extract ZIP and run `AutoDrop.exe`
            - No installation required
            - Settings stored in `%AppData%\AutoDrop`
            
            ### ‚úÖ SHA256 Checksums
            See `checksums.txt` for file verification.
            
            ### What's New
            See commits since last release for changes.
          files: |
            ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-x64-setup.exe
            ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-x86-setup.exe
            ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-x64-portable.zip
            ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-x86-portable.zip
            ./AutoDrop-${{ steps.version.outputs.VERSION }}-win-arm64-portable.zip
            ./checksums.txt
          draft: false
          prerelease: ${{ contains(github.ref_name, '-pre') || contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
